pipeline {
    agent any
    stages {
        stage('Clear older deployments') {
            steps {
                sh '/bin/rm -rf ./alfresco-sdk4'
            }
        }
        stage('Build and Test') {
            steps {
                sh './run.sh build_test'
            }
        }
        stage('Get artifacts') {
            steps {
                sh 'wget "https://github.com/miguel-rodriguez/alfresco-sdk4/tree/master/CodeDeploy"'
                sh 'wget "http://localhost:8081/artifactory/libs-release-local/com/alfresco/my-all-in-one-platform-jar/1.0/my-all-in-one-platform-jar-1.0.jar"  -P "CodeDeploy/alfresco-repo-code-deploy/deployment/code-deploy-acs/platform_modules/"'
                sh 'wget "http://localhost:8081/artifactory/libs-release-local/com/alfresco/my-all-in-one-share-jar/1.0/my-all-in-one-share-jar-1.0.jar"  -P "CodeDeploy/alfresco-repo-code-deploy/deployment/code-deploy-acs/share_modules/"'
            }
        }
        stage('Zip CodeDeploy') {
            steps {
                catchError { 
                    sh '/bin/rm AlfrescoCodeDeploy.zip' 
                }
                sh 'zip -r ./AlfrescoCodeDeploy.zip CodeDeploy'
            }
        }   
         stage('Upload to S3') {
            steps {
                sh 'aws s3 cp ./AlfrescoCodeDeploy.zip s3://miguel-acs-61'
            }
        }            
        stage('Clean up') {
            steps {
                sh 'mvn clean'
            }
        }
    }
}
