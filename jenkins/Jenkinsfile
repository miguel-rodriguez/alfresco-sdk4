pipeline {
    agent any
    stages {
        stage('Build and Test') {
            steps {
                sh './run.sh build_test'
            }
        }
        stage('Get repo artifacts') {
            steps {
                sh 'wget -r --no-parent "https://github.com/miguel-rodriguez/alfresco-sdk4/tree/master/CodeDeploy/alfresco-repo-code-deploy"'
                sh 'wget "http://localhost:8081/artifactory/libs-release-local/com/alfresco/my-all-in-one-platform-jar/1.0/my-all-in-one-platform-jar-1.0.jar"  -P "CodeDeploy/alfresco-repo-code-deploy/deployment/code-deploy-acs/platform_modules/"'
                sh 'wget "http://localhost:8081/artifactory/libs-release-local/com/alfresco/my-all-in-one-share-jar/1.0/my-all-in-one-share-jar-1.0.jar"  -P "CodeDeploy/alfresco-repo-code-deploy/deployment/code-deploy-acs/share_modules/"'
            }
        }
        stage('Zip Repo CodeDeploy') {
            steps {
                catchError { 
                    sh '/bin/rm CodeDeploy/AlfrescoRepoCodeDeploy.zip' 
                    sh 'exit 0'
                }
                sh 'cd CodeDeploy/alfresco-repo-code-deploy && zip -r ./AlfrescoRepoCodeDeploy.zip *y'
            }
        }   
         stage('Upload Repo Zip to S3') {
            steps {
                sh 'aws s3 cp ./CodeDeploy/AlfrescoRepoCodeDeploy.zip s3://mr-acs-61-code-deploy'
            }
        }
        stage('Get solr artifacts') {
            steps {
                sh 'wget -r --no-parent "https://github.com/miguel-rodriguez/alfresco-sdk4/tree/master/CodeDeploy/alfresco-solr-code-deploy"'
                sh 'wget "http://localhost:8081/artifactory/libs-release-local/com/alfresco/my-all-in-one-platform-jar/1.0/my-all-in-one-platform-jar-1.0.jar"  -P "CodeDeploy/alfresco-repo-code-deploy/deployment/code-deploy-acs/platform_modules/"'
                sh 'wget "http://localhost:8081/artifactory/libs-release-local/com/alfresco/my-all-in-one-share-jar/1.0/my-all-in-one-share-jar-1.0.jar"  -P "CodeDeploy/alfresco-repo-code-deploy/deployment/code-deploy-acs/share_modules/"'
            }
        }
        stage('Zip Solr CodeDeploy') {
            steps {
                catchError { 
                    sh '/bin/rm CodeDeploy/AlfrescoSolrCodeDeploy.zip' 
                    sh 'exit 0'
                }
                sh 'cd CodeDeploy/alfresco-solr-code-deploy && zip -r ./AlfrescoSolrCodeDeploy.zip *'
            }
        }   
         stage('Upload Solr Zip to S3') {
            steps {
                sh 'aws s3 cp ./CodeDeploy/AlfrescoSolrCodeDeploy.zip s3://mr-acs-61-code-deploy'
            }
        }
    }
}
