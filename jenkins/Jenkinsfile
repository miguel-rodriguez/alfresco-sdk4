pipeline {
    agent any
    stages {
        stage('Build and Test') {
            steps {
                sh './run.sh build_test'
            }
        }
        stage('Save artifacts') {
            steps {
                sh 'cp my-all-in-one-platform-jar/target/my-all-in-one-platform-jar-1.0-SNAPSHOT.jar CodeDeploy/alfresco-repo-code-deploy/deployment/code-deploy-acs/platform_modules/'
                sh 'cp my-all-in-one-share-jar/target/my-all-in-one-share-jar-1.0-SNAPSHOT.jar CodeDeploy/alfresco-repo-code-deploy/deployment/code-deploy-acs/share_modules/'
            }
        }
        stage('Zip CodeDeploy') {
            steps {
                sh '/bin/rm AlfrescoCodeDeploy.zip'
                sh 'zip ./AlfrescoCodeDeploy.zip CodeDeploy'
            }
        }   
         stage('Upload CodeDeploy zip file to S3') {
            steps {
                sh 'aws s3 cp ./AlfrescoCodeDeploy.zip s3://miguel-acs-61'
            }
        }            
        stage('Clean up') {
            steps {
                sh 'mvn clean'
            }
        }
    }
}
